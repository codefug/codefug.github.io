# ë°°ê²½

ì´ë²ˆ í”„ë¡œì íŠ¸ì˜ ë§ˆìŒê°€ì§ì€ íŒ€ì›ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ëŠ” ê°œì¸ì´ ë˜ì ì˜€ëŠ”ë°ìš”. íŒ€ì¥ ì§ì±…ì„ ê°ì‚¬í•˜ê²Œë„ ë§¡ê²Œ ë˜ì–´ì„œ ì¢€ ë” ê·¸ ì±…ì„ì´ ì»¸ìŠµë‹ˆë‹¤.

ê·¸ ì±…ì„ê°ìœ¼ë¡œ ì¸í•˜ì—¬ ì œ ë¶€ë¶„ ì´ì™¸ì—ë„ íŒ€ì›ë“¤ì´ ê°œë°œì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ ë§ì€ ì‘ì—…ë“¤ì„ í•´ì™”ëŠ”ë°ìš”.

S3ë¥¼ ì´ìš©í•œ S3 urlì— ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ëŠ” í•¨ìˆ˜ êµ¬í˜„ê°™ì€ ê¼­ í•„ìš”í•œ ê²ƒë¶€í„° ë¸”ëŸ¬ ì²˜ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸ ê°œë°œê¹Œì§€ ì œ ë¶€ë¶„ ì´ì™¸ì—ë„ ì—¬ëŸ¬ê°€ì§€ ì‘ì—…ë“¤ì„ í•´ì™”ìŠµë‹ˆë‹¤.

ì €í¬ íŒ€ì´ ë§Œë‚¬ë˜ ë¬¸ì œëŠ” ë‘ê°€ì§€ì˜€ìŠµë‹ˆë‹¤.

1. ì‚¬ì¥ë‹˜ ê³„ì •ê³¼ ì•Œë°”ë‹˜ ê³„ì •ì„ ë¶„ë¦¬í•˜ëŠ” ê²ƒê¹Œì§€ëŠ” ì¿ í‚¤ë¥¼ ì´ìš©í•´ì„œ ê°€ëŠ¥í–ˆì§€ë§Œ ì ‘ê·¼ ì œí•œì„ êµ¬í˜„í•˜ëŠ” ê²Œ ì–´ë µë‹¤.
2. vercel organizationì€ ìœ ë£Œ ë°°í¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ë”ë¶ˆì–´ PRì‹œ í”„ë¦¬ë·°ê¹Œì§€ ë³´ì—¬ì¤¬ìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì—¬ì •ì„ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

# êµ¬í˜„

## middle ware

ë¯¸ë“¤ì›¨ì–´ì˜ ì¡´ì¬ëŠ” ìº¡ìŠ¤í†¤ ë””ìì¸ìœ¼ë¡œ express ì„œë²„ë¥¼ êµ¬í˜„í•  ë•Œ ëŒ€ëµì ìœ¼ë¡œ ì•Œê³  ìˆì—ˆìŠµë‹ˆë‹¤.

ë¬´ì–¸ê°€ì˜ ì‚¬ì´ì— ìˆëŠ” ì¡´ì¬ ì •ë„ë¡œ ìƒê°í–ˆì—ˆëŠ”ë°ìš”. nextì˜ ê³µì‹ë¬¸ì„œì—ì„œ middle wareì˜ ì¡´ì¬ë¥¼ ì•Œê²Œëœ í›„ ì¢€ ë” ì°¾ì•„ë´ì•¼ê² ë‹¤ëŠ” ìƒê°ì„ í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

nextì—ì„œ middle wareëŠ” ë¸Œë¼ìš°ì €ì™€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì‚¬ì´ì— ì¡´ì¬í•œë‹¤ê³  ìƒê°í•˜ë©´ ë©ë‹ˆë‹¤.

í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ì— ì €ì¥ëœ ì¿ í‚¤ë¥¼ í™œìš©í•´ ì‚¬ìš©ìë¥¼ íŒë³„í•˜ê³  ì•Œë§ê²Œ ë Œë”ë§ ì‹œí‚¤ëŠ” ë¡œì§ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```tsx
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { getCookie } from "./app/_util/cookie";

/**
 * ì‚¬ì´íŠ¸ì˜ ì œí•œ ì¡°ê±´ì— ê±¸ë ¸ì„ ë•Œ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œì¼œì£¼ëŠ” ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤.
 * @author ì´ìŠ¹í˜„
 * @param request
 * @returns
 */
export default async function loginRequired(request: NextRequest) {
  const token = await getCookie("accessToken");
  const type = await getCookie("type");
  const isLandingPage = request.nextUrl.pathname === "/";
  const isAdminPage = request.nextUrl.pathname.startsWith("/admin");
  const isAlbaPage =
    request.nextUrl.pathname.startsWith("/profile-detail") ||
    request.nextUrl.pathname.startsWith("/profile-register");

  if (isLandingPage && token) {
    return NextResponse.redirect(new URL("/notice-list", request.url));
  }

  if (isLandingPage) {
    return NextResponse.next();
  }

  if (!token) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  if (type === "employee" && isAdminPage) {
    return NextResponse.redirect(new URL("/notice-list", request.url));
  }
  if (type === "employer" && isAlbaPage) {
    return NextResponse.redirect(new URL("/notice-list", request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    // ì•„ë˜ í˜ì´ì§€ë“¤ì€ ê³µí†µìœ¼ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.
    "/((?!login|signup|notice-list|notice-detail|api|_next/static|_next/image|images|icons|fonts|favicon.ico).*)",
  ],
};
```

requestë¥¼ ë°›ì•„ì„œ í™•ì¸í•œ í›„ responseë¡œ ì²˜ë¦¬í•œ ëª¨ìŠµì…ë‹ˆë‹¤.

ì‚¬ì¥ë‹˜ í˜ì´ì§€, ì•Œë°”ë‹˜ í˜ì´ì§€, ì´ˆê¸° í™”ë©´ ë“±ì„ ì˜ êµ¬ë¶„í•´ì„œ ì •ë¦¬í•œ í›„ ì´ë¥¼ responseì— ë‹´ì•„ì„œ ê°€ë…ì„±ì„ ë†’í˜”ìŠµë‹ˆë‹¤.

## vercel github action

ì›ë˜ëŠ” ê¸°ì´ˆ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í–ˆë˜ netlifyë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í–ˆìœ¼ë‚˜ Nextë¥¼ ì“°ëŠ” ê²ƒì´ë‹ˆ ë§Œí¼ vercelì„ ì´ìš©í•œ ë°°í¬ê°€ ì¢‹ì§€ ì•Šì„ê¹Œ ìƒê°í•˜ì˜€ê³  íŒ€ì›ë“¤ë„ ë™ì˜í•´ì¤˜ì„œ ì´ëŒ€ë¡œ ì§„í–‰í•˜ê²Œ ë˜ì—ˆë‹¤.

ì´ë²ˆì—ë„ ìë™ ë°°í¬ë¥¼ ìœ„í•´ì„œ github acitonì„ ì‚¬ìš©í•´ì•¼ ë˜ë‚˜ ìƒê°í–ˆì§€ë§Œ ê·¸ëŸ´ í•„ìš” ì—†ì´ vercelì—ì„œ ìë™ë°°í¬ë¥¼ í•´ì£¼ê³  previewê¹Œì§€ prë§ˆë‹¤ ë³´ì—¬ì¤€ë‹¤ê³  í•´ì„œ í¸í•˜ê²Œ ìƒê°í–ˆì—ˆë‹¤.

ì—¬ê¸°ì„œ ë¬¸ì œëŠ” teamì¼ ê²½ìš°ì—ëŠ” ìœ ë£Œë¡œ ë°°í¬ë¥¼ í•´ì•¼í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722182732.png)

ë‹¤ë¥¸ yaml ì½”ë“œë¥¼ ë¶„ì„í•˜ë˜ ì¤‘ì— preview ìª½ì—ì„œ CLIë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì„ ë°œê²¬í•˜ê³  organizationì€ CLIì—ì„œ ë¬´ë£Œì¸ê°€? ìƒê° í›„ ì°¾ì•„ë³´ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.

ì°¾ì•„ë³´ë˜ ì¤‘ ê¹ƒí—ˆë¸Œ ì´ìŠˆì—ì„œ í•œë§ˆë””ë¥¼ ë³´ê²Œ ë˜ì—ˆë‹¤.

> vercel CLIë¡œ ì ‘ê·¼í•˜ëŠ” ê²ƒ ë°–ì—ëŠ” ë°©ë²•ì´ ì—†ëŠ” ê²ƒ ê°™ë„¤. CLI í•œë²ˆ ì¨ë´ (ì˜ì–´)

organization GUI ìœ ë£Œ > organization CLI ë¬´ë£Œ ì¸ ê±°ì˜€ìŠµë‹ˆë‹¤.

ë‚˜ì˜ ìƒí™©ì— ë”± ë§ëŠ” ë¬¸ì„œë¥¼ ì°¾ê²Œ ë˜ì–´ì„œ ì§„í–‰í•˜ê²Œ ë˜ì—ˆë‹¤. ì´ì œ ë§ì´ í–ˆê¸°ì— ê°„ë‹¨í•œ ìš©ì–´ ì •ë„ëŠ” ì•Œê³  ìˆìŒì— ê¸°ë»í•˜ë©° ë§ì…ë‹ˆë‹¤.

### vercel CLI ì‹¤í–‰

```terminal
npm i -g vercel

vercel
```

> .github íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ CLIë¡œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤. ë”°ë¡œ ì˜®ê²¨ë‘” í›„ ì—°ê²°í•˜ê³  ë‹¤ì‹œ ì§„í–‰í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

vercelì„ ì„¤ì¹˜í›„ ì‹¤í–‰í•©ë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722183549.png)

ìœ„ì²˜ëŸ¼ ì‹œí‚¤ëŠ” ëŒ€ë¡œ ëŒ€ë‹µí•œ í›„ì— ë³´ë©´ ë‚˜ì˜ í”„ë¡œì íŠ¸ í´ë”ì— `.vercel` ì´ë¼ëŠ” í´ë”ê°€ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```json
// .vercel
{ "orgId": "...", "projectId": "..." }
```

ìœ„ì²˜ëŸ¼ ë§ì…ë‹ˆë‹¤. ë‚´ í”„ë¡œì íŠ¸ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•´ì„œ ì¡´ì¬í•˜ë‹ˆ ì–´ë””ì— ì ì–´ë‘ì.

ì´í›„ì—” vercelì— buildë¥¼ ë§¡ê¸°ê¸° ìœ„í•´ [amondnet/vercel-action](https://github.com/amondnet/vercel-action) ë¼ëŠ” ì•¡ì…˜ì„ ì“¸ ê²ƒì…ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ì„  account tokenì„ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722183804.png)

ì§€ê¸ˆê¹Œì§€ ì–»ì€ 3ê°€ì§€ í† í°ì„ secretì— ë‹´ì•„ë³´ê² ìŠµë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722183946.png)

ì´í›„ developerì—ì„œ github ìì²´ í† í°ë„ í•˜ë‚˜ ì–»ì–´ì„œ API_TOKEN-GITHUBì— secretìœ¼ë¡œ ì €ì¥í•´ë†“ëŠ”ë‹¤.

ì´ì œ ì¤€ë¹„ëŠ” ëë‚¬ë‹¤. /.github/workflows íŒŒì¼ì— ì•„ë˜ì˜ íŒŒì¼ë“¤ì„ ë„£ì–´ì£¼ì.

```yaml
# vercel-merge.yml
name: Deploy to vercel on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.API_TOKEN_GITHUB }}
          vercel-args: "--prod"
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID}}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID}}
```

ì´ íŒŒì¼ì€ vercel-actionì„ ì´ìš©í•´ì„œ vercel tokenê³¼ github tokenì— ë§ëŠ” ë°°í¬ë¥¼ í•©ë‹ˆë‹¤. branchesë¥¼ í†µí•´ ë¸Œëœì¹˜ë¥¼ íŠ¹ì •í•´ë†¨ëŠ”ë° ìš°ë¦¬ íŒ€ì€ mainì´ ë°°í¬ ë¸Œëœì¹˜ì´ê¸° ë•Œë¬¸ì— mainì— pushí•˜ëŠ” ìˆœê°„ vercelì— ë°°í¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

```yaml
# vercel-pull-request.yml
name: Create vercel preview URL on pull request
on:
  pull_request:
    branches:
      - develop
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: amondnet/vercel-action@v20
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID}}
          vercel-project-id: ${{ secrets.PROJECT_ID}}
      - name: preview-url
        run: |
          echo ${{ steps.vercel-deploy.outputs.preview-url }}
```

previewì˜ ê²½ìš°ì—ë„ ì´ì™€ ê°™ìŠµë‹ˆë‹¤. ì´ì œ PRì—ì„œ commitë  ë•Œë§ˆë‹¤ ìµœìƒë‹¨ì˜ commitì´ ë°”ë€Œê²Œ ë  ê²ƒì…ë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722184634.png)

github actionì„ ì´ìš©í•œ ìë™ë°°í¬ê°€ ì™„ë£Œëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

https://gheup-pay-project.vercel.app/

![](/images/2024-07-23/Pasted%20image%2020240722184808.png)

í”„ë¦¬ë·° ì—­ì‹œ ì„±ê³µì ìœ¼ë¡œ ë³´ì—¬ì§€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](/images/2024-07-23/Pasted%20image%2020240722184832.png)

í•˜ì§€ë§Œ ê¸°ì¡´ì— vercelì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ì½”ë“œê°€ ì¡´ì¬í–ˆê³  previewëŠ” íŒ€ì›ë“¤ì´ êµ‰ì¥íˆ ìì£¼ ì“°ëŠ” ë¶€ë¶„ì´ê¸° ë•Œë¬¸ì— êµì²´í•˜ëŠ” ì‹œê¸°ê°€ ì• ë§¤í•´ì ¸ì„œ ì ìš©ì€ í•˜ì§€ ì•Šê²Œ ë˜ì—ˆë‹¤.

ì•„ë˜ì˜ ì½”ë“œë„ ìœ„ì˜ ì½”ë“œì™€ ìœ ì‚¬í•˜ê²Œ ê¸°ëŠ¥í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

```yaml
name: Preview

on:
  pull_request:
    branches: ["develop"]

jobs:
  vercel-preview:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      deployments: write
      id-token: write
      issues: write
      pull-requests: write

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Get Vercel Environment Variables
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} > vercel-output.txt
          echo "preview_url=$(cat vercel-output.txt)" >> $GITHUB_OUTPUT

      - name: Comment PR with Preview URL
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ğŸ‰ êµ¬í˜„í•œ ê¸°ëŠ¥ Preview: ${{ steps.deploy.outputs.preview_url }}
```

![](/images/2024-07-23/Pasted%20image%2020240722185400.png)

ìœ„ì²˜ëŸ¼ PRì˜ ì»¤ë°‹ë§ˆë‹¤ URLì„ commentë¡œ ë‹¬ì•„ì¤€ë‹¤.

# reference

<a href="https://gist.github.com/ky28059/1c9af929a9030105da8cf00006b50484">
  vercel CLI ë°°í¬ ê´€ë ¨ gist
</a>

https://nextjs.org/docs/app/building-your-application/routing/middleware

> ê¸‰í˜ì´ í”„ë¡œì íŠ¸ ì¤‘ ê³ ë¯¼í–ˆë˜ ë°©ì‹, ë¶€ë”ªíˆê²Œ ëœ ë¬¸ì œ, ê·¸ê²ƒì˜ í•´ê²°ê³¼ì •ì„ ë‹´ì€ ê¸€ì…ë‹ˆë‹¤!
>
> ì˜ëª»ëœ ë‚´ìš©ì´ ìˆë‹¤ë©´ ë§ì”€ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.
